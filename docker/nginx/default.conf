upstream vaadin_backend {
    server vaadin:8080;
}

upstream prerender_backend {
    server prerender:3000;
}

server {
    listen 80;
    server_name yourdomain.com;

    # 健康检查端点
    location /health {
        proxy_pass http://vaadin_backend/actuator/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        # 设置默认不使用 prerender
        set $prerender 0;

        # 判断是否是爬虫 UA
        if ($http_user_agent ~* "Googlebot|Bingbot|Yandex|facebookexternalhit|Twitterbot|LinkedInBot|WhatsApp|TelegramBot|Slackbot|Discordbot|SkypeUriPreview|Slack-ImgProxy|WhatsApp|Telegram|Discord|Slack") {
            set $prerender 1;
        }

        # 检查是否有 _escaped_fragment_ 参数（用于手动测试）
        if ($args ~ "_escaped_fragment_") {
            set $prerender 1;
        }

        # 转发爬虫请求到 prerender 服务
        if ($prerender = 1) {
            proxy_pass http://prerender_backend/;
            proxy_set_header X-Prerender-Token YOUR_TOKEN; # 可选，默认不校验
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $host;
            proxy_set_header X-Original-URL $scheme://$host$request_uri;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass_request_headers on;

            # 设置超时时间
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # 正常用户请求走 Spring Boot（Vaadin）
        if ($prerender = 0) {
            proxy_pass http://vaadin_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket 支持（Vaadin 需要）
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://vaadin_backend;
        proxy_set_header Host $host;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
